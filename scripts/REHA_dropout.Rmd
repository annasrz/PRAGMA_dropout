---
title: "reha_dropout"
author: "Anna"
date: "2024-08-09"
output: 
  html_document:
    code_folding: hide
---
# To-Dos

- ....


REHA kann sowohl in stationärer als auch in ambulanter Form durchgeführt werden, und sowohl über die GVK als auch DRV laufen. REHA dauert in der Regel mehrere Monate, kann aber auch bis zu einem Jahr dauern.
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(warn = -1)
```
# Vorbereitungen

```{r essentials}
# clean workspace
rm(list=ls())
packages <- c("data.table", "tidyverse", "ggplot2", "comorbidity", "car", "lme4", "ordinal", "export", "mclogit", "sjPlot", "see", "nnet")

# Install packages not yet installed
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}
# Load packages
invisible(lapply(packages, library, character.only = TRUE))

# current date:
DATE <- format(Sys.Date(), "%Y%m%d")

# themes and options
options(scipen = 999)

# output folders
folder_table <- file.path("..", "output/tables")
folder_plot <- file.path("..", "output/figures")

if (!file.exists(folder_table)) {
  dir.create(folder_table, recursive = TRUE)
}

if (!file.exists(folder_plot)) {
  dir.create(folder_plot, recursive = TRUE)
}
```
# Daten Import

```{r data_import}
print(getwd())
datapath <- file.path("..", "input") 
#read in all files in datapath 
filenames <- list.files(datapath, pattern = "\\.rds$", full.names = T)

#save all files as separate dataframes
ldf <- lapply(filenames, readRDS)
names(ldf) <- gsub(".rds", "", basename(filenames))
print(names(ldf))
names <- c("pragma_id_GKV", "alc_diagnoses", "all_diagnoses", "medications", "employment", "fosterage", "income", "insurance_periods", "inpat_OPS", "inpat", "qwt_OPS", "qwt", "reha", "drvreha_specifics")
names(ldf) <- names
#check if all dataframes are loaded
ls()
list2env(ldf, envir = .GlobalEnv) #save all dataframes in global environment as dataframes
rm(ldf)
```
# Daten vorbereiten

## Outcome Variablen Definition? 

### Behandlungsdauer als AV
```{r rehaduration}
str(reha)
reha$n.days <- as.integer(difftime(as.Date(reha$date.reha.end), as.Date(reha$date.reha.start), units = "days")) + 1
head(reha)

summary(reha$n.days)

#distribution of reha.typ by source
table(reha$reha.typ, reha$source) #gkv: ambulant & stationär, drv: ambulant & ganztägig ambulante Maßnahme & stationäre Maßnahme

ggplot(reha, aes(x = reha.typ, y = n.days)) +
  geom_jitter(alpha=0.2, size = rel(0.8), height = 0.2) +
#  geom_violinhalf(width = 0.3, outlier.shape = NA) +
  geom_boxplot(width = 0.2, outlier.shape = NA) +
  facet_wrap(~source) +
  #rotate x axis labels
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(limits = c(0, 800), breaks = seq(0, 800, by = 30))

```
Fazit: schwierig einheitliche Definition zu finden von "Behandlungserfolg" bzw. "Abbruch". Reha-Dauer variiert wahrscheinlich nicht nur durch Abbrüche (dh stellt nicht reines "Durchhalten" dar), sondern auch je nach Bedarf. Beispiel: ambulante Reha hat drei Peaks (1. etwa um 180 Tage, 2. etwa um 360 Zage, 3. etwa um 540 Tage). Jemand der 180 Tage schafft, könnte sowohl seine REHA vollständig absolviert haben, oder aber ein Behandlungsabbrecher sein, da er eigentlich einen Bedarf für eine 360 Tages Reha gehabt hätte.

Weiteres Vorgehen:
Die DRV Daten enthalten die ENTL (Entlassform) und die Diagnose-Veränderungs Variablen. Ziehen wir diese zur Validierung hinzu. Dafür brauchen wir die HIV codes (in meinen DRV Daten gibt es keine PragmaID). 

## Hinweise aus DRV Daten

### Matching

```{r get hivid}
reha <- left_join(reha, pragma_id_GKV %>% select(c("hivid", "pragmaid")), by = "pragmaid")
reha <- left_join(reha, drvreha_specifics %>% select(c("hivid", "DIAG_VERAEND", "ENTLASSFORM")), by = "hivid")

#filter for BEWILLDIAG starting with F10
drv_reha_test <- drvreha_specifics %>% filter(BEWILLDIAG %like% "F10" | DIAG_GRUPPE %like% "Störungen durch Alkohol" | DIAG1 %like% "F10")

str(drv_reha_test)
drv_reha_test$n.days <- as.integer(difftime(as.Date(drv_reha_test$date.drvreha.end), as.Date(drv_reha_test$date.drvreha.start), units = "days")) + 1

summary(drv_reha_test$n.days)

#rename labels of ENTLASSFORM
drv_reha_test <- drv_reha_test %>%
  mutate(ENTLASSFORM = fct_recode(as.factor(ENTLASSFORM),
                                  "disz" = "disziplinarisch",
                                  "regulär" = "regulär",
                                  "verlegt" = "verlegt",
                                  "vorz. ärztl. Veranl." = "vorzeitig auf ärztliche Veranlassung",
                                  "vorz. m. ä. Einv. gg. ä. Rat" = "vorzeitig mit ärztlichem Einverständnis/vorzeitig gegen ärztlichen Rat",
                                  "Wechsel" = "Wechsel der Durchführungsart"),
         MASSN_ART = fct_recode(as.factor(MASSN_ART),
                                "ambulant" = "ambulante Maßnahme",
                                "ganztäg. ambul." = "ganztägig ambulante Maßnahme",
                                "stationär" = "stationäre Maßnahme"))
# Behandlungsdauer nach Entlassform und Maßnahmenart
ggplot(drv_reha_test, aes(x = ENTLASSFORM, y = n.days)) +
  geom_jitter(alpha=0.2, size = rel(0.8), height = 0.2) +
#  geom_violinhalf(width = 0.3, outlier.shape = NA) +
  geom_boxplot(width = 0.2, outlier.shape = NA) +
  facet_wrap(~MASSN_ART, scales = "free_y") +
  #rotate x axis labels
  theme(axis.text.x = element_text(angle = 45, size = 5, hjust = 1)) 
#  scale_y_continuous(limits = c(0, 800), breaks = seq(0, 800, by = 30))

# Behandlungsdauer nach Entlassform, Maßnahmenart und Diagnoseveränderung
treatmentdurationDRVReha <- ggplot(drv_reha_test %>% filter (ENTLASSFORM != "verstorben"), aes(x = ENTLASSFORM, y = n.days)) +
  geom_jitter(alpha=0.2, size = rel(0.72), height = 0.2) +
#  geom_violinhalf(width = 0.3, outlier.shape = NA) +
  geom_boxplot(width = 0.34, outlier.shape = NA) +
  facet_grid(MASSN_ART ~ DIAG_VERAEND, scales = "free_y") +
  #rotate x axis labels
  theme(axis.text.x = element_text(angle = 45, size = 6, hjust = 1)) +
  labs(y= "Behandlungsdauer (in Tagen)", x = "Entlassungsform")

#save plot
ggsave(file.path(folder_plot, "treatmentdurationDRVReha.png"), treatmentdurationDRVReha, width = 10, height = 10, units = "cm")
#save plot in a better solution 
ggsave(file.path(folder_plot, "treatmentdurationDRVReha.png"), treatmentdurationDRVReha, width = 20, height = 15, units = "cm")

# Behandlungsdauer nach Maßnahmenart und Diagnoseveränderung
ggplot(drv_reha_test, aes(x = DIAG_VERAEND, y = n.days)) +
  geom_jitter(alpha=0.2, size = rel(0.8), height = 0.2) +
#  geom_violinhalf(width = 0.3, outlier.shape = NA) +
  geom_boxplot(width = 0.2, outlier.shape = NA) +
  facet_grid(MASSN_ART ~ ., scales = "free_y") +
  #rotate x axis labels
  theme(axis.text.x = element_text(angle = 45, size = 8, hjust = 1)) 

```
Aus DRV Reha Infofile:

Eine stationäre Kurzzeittherapie für Alkohol und Medikamentenabhängige dauert in der Regel 8 Wochen;
Eine Standardtherapie bei Alkohol und Medikamentenabhängigkeit kann bis 15 Wochen stationär durchgeführt werden. 

Ganztägig ambulant: bis zu 17 Wochen (etwa 100 Tage)

Ambulante: dauert in der Regel 6 bis 12, maximal 18 Monate.
